<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web3 Çarklı Çekiliş</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: white;
      padding: 20px;
    }

    .container {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .draw-card {
      background: #1d1d1d;
      border: 1px solid #444;
      padding: 15px;
      border-radius: 12px;
      width: 280px;
    }

    .draw-card h3 {
      margin-top: 0;
    }

    .section {
      border: 1px solid #333;
      border-radius: 12px;
      padding: 16px;
      margin: 10px auto;
      width: 90%;
      max-width: 600px;
      background: #1d1d1d;
    }

    .detail-section {
      margin-top: 30px;
      display: none;
    }

    textarea, input[type="text"], input[type="date"] {
      width: 100%;
      margin-bottom: 10px;
      border-radius: 10px;
      padding: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #00bcd4;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
  </style>
</head>
<body>
  <button id="connectWalletBtn" onclick="connectWallet()">🔌 Cüzdanı Bağla</button>
  <h1>🌀 Aktif Çekilişler</h1>
  <div class="container" id="drawList"></div>
  <button onclick="showCreateForm()">+ Yeni Çekiliş Başlat</button>

  <div class="section detail-section" id="drawDetails">
    <h2 id="drawTitle"></h2>
    <p id="drawDeadline"></p>
    <p id="drawParticipants"></p>
    <p><strong>Kazanan:</strong> <span id="winnerAddress">Henüz belirlenmedi</span></p>

    <h3>Katılım Görevleri</h3>
    <ul>
      <li><input type="checkbox" id="followCheck" disabled> Twitter hesabını takip et (@TokenPro)</li>
      <li><input type="checkbox" id="likeCheck" disabled> Belirtilen tweet'i beğen</li>
      <li><input type="checkbox" id="retweetCheck" disabled> Tweet'i retweetle</li>
      <li><input type="checkbox" id="commentCheck" disabled> Tweet'e yorum yap</li>
    </ul>
    <button onclick="simulateTasks()">Görevleri Doğrula</button>
    <button id="joinBtn" onclick="joinDraw()" disabled>Çekilişe Katıl</button>
  </div>

  <div class="section detail-section" id="createSection" style="display:none">
    <h2>Yeni Çekiliş Oluştur</h2>
    <p>Çekiliş başlatmak için 0.001 ETH ödeme yapılacaktır.</p>
    <input type="text" id="newTitle" placeholder="Çekiliş Başlığı" />
    <input type="date" id="newEnd" placeholder="Bitiş Tarihi" />
    <h4>Görev Seçimi:</h4>
    <label><input type="checkbox" id="taskFollow"> Takip</label><br />
    <label><input type="checkbox" id="taskLike"> Beğeni</label><br />
    <label><input type="checkbox" id="taskRetweet"> Retweet</label><br />
    <label><input type="checkbox" id="taskComment"> Yorum</label>
    <button onclick="createDraw()">Çekilişi Başlat</button>
  </div>

  <canvas id="wheelCanvas" width="400" height="400" style="display:none; margin:auto; display:block; background:#fff; border-radius:50%; border:5px solid #00bcd4"></canvas>
  <div style="text-align:center">
    <button id="spinButton" style="display:none" onclick="spinWheel()">🎯 Çarkı Çevir</button>
  </div>

  <script>
    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          document.getElementById("connectWalletBtn").innerText = `🔗 ${address.slice(0,6)}...${address.slice(-4)}`;
        } catch (err) {
          alert("Cüzdan bağlantısı reddedildi.");
        }
      } else {
        alert("Metamask yüklü değil.");
      }
    }

    function showCreateForm() {
      document.getElementById("createSection").style.display = "block";
    }

    async function createDraw() {
      try {
        const title = document.getElementById("newTitle").value;
        const deadline = document.getElementById("newEnd").value;
        const tasks = [
          document.getElementById("taskFollow").checked,
          document.getElementById("taskLike").checked,
          document.getElementById("taskRetweet").checked,
          document.getElementById("taskComment").checked,
        ];

        if (!title || !deadline) {
          alert("Başlık ve bitiş tarihi zorunludur.");
          return;
        }

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contractAddress = "0x030b936c37027d6f524bf5aa29b43775b6c86e0e";
        const abi = [
          "function createDraw(string memory title, string memory deadline, bool[4] memory tasks) public payable"
        ];
        const contract = new ethers.Contract(contractAddress, abi, signer);

        const fee = ethers.utils.parseEther("0.001");
        const balance = await signer.getBalance();
        if (balance.lt(fee)) {
          alert("Yeterli ETH yok. 0.001 ETH gerekiyor.");
          return;
        }

        const tx = await contract.createDraw(title, deadline, tasks, { value: fee });
        await tx.wait();
        alert("Çekiliş başarıyla başlatıldı.");
        document.getElementById("createSection").style.display = "none";
      } catch (err) {
        console.error("Çekiliş başlatılamadı:", err);
        alert("Bir hata oluştu. Konsolu kontrol et.");
      }
    }
  </script>
</body>
</html>
