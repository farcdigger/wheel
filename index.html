<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web3 Ã‡arklÄ± Ã‡ekiliÅŸ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      background: linear-gradient(45deg, #00bcd4, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      margin: 0;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .draw-card {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      border: 1px solid #444;
      padding: 20px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .draw-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 188, 212, 0.3);
      border-color: #00bcd4;
    }

    .draw-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .draw-card:hover::before {
      left: 100%;
    }

    .draw-card h3 {
      margin-top: 0;
      color: #00bcd4;
      font-size: 1.3rem;
    }

    .draw-card p {
      margin: 8px 0;
      opacity: 0.9;
    }

    .section {
      border: 1px solid #333;
      border-radius: 15px;
      padding: 25px;
      margin: 20px auto;
      width: 90%;
      max-width: 700px;
      background: linear-gradient(145deg, #1e1e2e, #252540);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .detail-section {
      margin-top: 30px;
      display: none;
    }

    .tasks-list {
      background: #2a2a3e;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }

    .tasks-list li {
      margin: 10px 0;
      padding: 8px;
      background: #333;
      border-radius: 5px;
      list-style: none;
    }

    .tasks-list input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }

    textarea, input[type="text"], input[type="date"] {
      width: 100%;
      margin-bottom: 15px;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #444;
      background: #2a2a3e;
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: #00bcd4;
      box-shadow: 0 0 10px rgba(0, 188, 212, 0.3);
    }

    button {
      padding: 12px 25px;
      font-size: 16px;
      background: linear-gradient(45deg, #00bcd4, #0097a7);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
      color: white;
      font-weight: bold;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    }

    .btn-success {
      background: linear-gradient(45deg, #4caf50, #45a049);
    }

    #wheelCanvas {
      display: none;
      margin: 20px auto;
      border-radius: 50%;
      border: 5px solid #00bcd4;
      box-shadow: 0 0 30px rgba(0, 188, 212, 0.5);
    }

    .wheel-container {
      text-align: center;
      margin: 30px 0;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-active {
      background: #4caf50;
      color: white;
    }

    .status-ended {
      background: #f44336;
      color: white;
    }

    .participant-count {
      background: #2196f3;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 14px;
      display: inline-block;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .section {
        width: 95%;
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <button id="connectWalletBtn" onclick="connectWallet()">ğŸ”Œ CÃ¼zdanÄ± BaÄŸla</button>
    <h1>ğŸŒ€ Web3 Ã‡arklÄ± Ã‡ekiliÅŸ</h1>
  </div>

  <div class="container" id="drawList">
    <!-- Ã‡ekiliÅŸler buraya yÃ¼klenecek -->
  </div>

  <div style="text-align: center;">
    <button onclick="showCreateForm()">+ Yeni Ã‡ekiliÅŸ BaÅŸlat</button>
  </div>

  <!-- Ã‡ekiliÅŸ Detay BÃ¶lÃ¼mÃ¼ -->
  <div class="section detail-section" id="drawDetails">
    <h2 id="drawTitle"></h2>
    <p><strong>BitiÅŸ Tarihi:</strong> <span id="drawDeadline"></span></p>
    <p><strong>KatÄ±lÄ±mcÄ± SayÄ±sÄ±:</strong> <span id="drawParticipants" class="participant-count">0</span></p>
    <p><strong>Kazanan:</strong> <span id="winnerAddress">HenÃ¼z belirlenmedi</span></p>

    <h3>KatÄ±lÄ±m GÃ¶revleri</h3>
    <ul class="tasks-list" id="tasksList">
      <!-- GÃ¶revler dinamik olarak yÃ¼klenecek -->
    </ul>
    
    <div style="text-align: center; margin: 20px 0;">
      <button onclick="simulateTasks()" class="btn-secondary">ğŸ” GÃ¶revleri DoÄŸrula</button>
      <button id="joinBtn" onclick="joinDraw()" disabled class="btn-success">âœ¨ Ã‡ekiliÅŸe KatÄ±l</button>
      <button id="selectWinnerBtn" onclick="selectWinner()" style="display:none;" class="btn-secondary">ğŸ¯ KazananÄ± SeÃ§</button>
    </div>
  </div>

  <!-- Ã‡ekiliÅŸ OluÅŸturma BÃ¶lÃ¼mÃ¼ -->
  <div class="section detail-section" id="createSection">
    <h2>ğŸš€ Yeni Ã‡ekiliÅŸ OluÅŸtur</h2>
    <p><strong>Not:</strong> Ã‡ekiliÅŸ baÅŸlatmak iÃ§in 0.001 ETH Ã¶deme yapÄ±lacaktÄ±r.</p>
    
    <input type="text" id="newTitle" placeholder="ğŸ Ã‡ekiliÅŸ BaÅŸlÄ±ÄŸÄ± (Ã¶rn: 100 USDT Ã‡ekiliÅŸi)" />
    <input type="date" id="newEnd" placeholder="ğŸ“… BitiÅŸ Tarihi" />
    
    <h4>ğŸ“‹ GÃ¶rev SeÃ§imi:</h4>
    <div style="background: #2a2a3e; padding: 15px; border-radius: 10px; margin: 10px 0;">
      <label style="display: block; margin: 10px 0;"><input type="checkbox" id="taskFollow"> ğŸ‘¥ Twitter hesabÄ±nÄ± takip et</label>
      <label style="display: block; margin: 10px 0;"><input type="checkbox" id="taskLike"> â¤ï¸ Tweet'i beÄŸen</label>
      <label style="display: block; margin: 10px 0;"><input type="checkbox" id="taskRetweet"> ğŸ”„ Tweet'i retweetle</label>
      <label style="display: block; margin: 10px 0;"><input type="checkbox" id="taskComment"> ğŸ’¬ Tweet'e yorum yap</label>
    </div>
    
    <div style="text-align: center;">
      <button onclick="createDraw()" class="btn-success">ğŸ‰ Ã‡ekiliÅŸi BaÅŸlat</button>
      <button onclick="hideCreateForm()" class="btn-secondary">âŒ Ä°ptal</button>
    </div>
  </div>

  <!-- Ã‡ark BÃ¶lÃ¼mÃ¼ -->
  <div class="wheel-container">
    <canvas id="wheelCanvas" width="400" height="400"></canvas>
    <div>
      <button id="spinButton" style="display:none" onclick="spinWheel()">ğŸ¯ Ã‡arkÄ± Ã‡evir</button>
    </div>
  </div>

  <script>
    let currentDrawIndex = -1;
    let participants = [];
    let userAccount = null;
    let draws = [];

    // Contract yapÄ±landÄ±rmasÄ±
    const CONTRACT_ADDRESS = "0xfcbb194cbe36e06c924966012f34c211f72af80d";
    const CONTRACT_ABI = [
      "function createDraw(string memory title, uint256 deadline, bool[4] memory tasks) public payable",
      "function joinDraw(uint256 drawId) public",
      "function setWinner(uint256 drawId, address winner) public",
      "function getParticipants(uint256 drawId) public view returns (address[] memory)",
      "function getDraw(uint256 drawId) public view returns (string memory title, uint256 deadline, bool[4] memory tasks, address creator, address winner, address[] memory participants, bool isActive, bool winnerSelected)",
      "function getDrawCount() public view returns (uint256)",
      "function getActiveDraws() public view returns (uint256[] memory)",
      "function isParticipant(uint256 drawId, address user) public view returns (bool)",
      "function getParticipantCount(uint256 drawId) public view returns (uint256)",
      "function cancelDraw(uint256 drawId) public",
      "event DrawCreated(uint256 indexed drawId, address indexed creator, string title, uint256 deadline)",
      "event ParticipantJoined(uint256 indexed drawId, address indexed participant)",
      "event WinnerSelected(uint256 indexed drawId, address indexed winner)"
    ];

    let contract = null;

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          userAccount = address;
          
          // Contract instance oluÅŸtur
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
          
          document.getElementById("connectWalletBtn").innerText = `ğŸ”— ${address.slice(0,6)}...${address.slice(-4)}`;
          document.getElementById("connectWalletBtn").style.background = "linear-gradient(45deg, #4caf50, #45a049)";
          
          await listDraws();
        } catch (err) {
          console.error("CÃ¼zdan baÄŸlantÄ± hatasÄ±:", err);
          alert("âŒ CÃ¼zdan baÄŸlantÄ±sÄ± reddedildi.");
        }
      } else {
        alert("âš ï¸ Metamask yÃ¼klÃ¼ deÄŸil. LÃ¼tfen Metamask kurunu yapÄ±n.");
      }
    }

    function showCreateForm() {
      document.getElementById("createSection").style.display = "block";
      document.getElementById("drawDetails").style.display = "none";
    }

    function hideCreateForm() {
      document.getElementById("createSection").style.display = "none";
    }

    async function createDraw() {
      try {
        if (!contract) {
          alert("âš ï¸ Ã–nce cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n.");
          return;
        }

        const title = document.getElementById("newTitle").value.trim();
        const deadlineInput = document.getElementById("newEnd").value;
        const tasks = [
          document.getElementById("taskFollow").checked,
          document.getElementById("taskLike").checked,
          document.getElementById("taskRetweet").checked,
          document.getElementById("taskComment").checked,
        ];

        if (!title || !deadlineInput) {
          alert("âš ï¸ BaÅŸlÄ±k ve bitiÅŸ tarihi zorunludur.");
          return;
        }

        if (!tasks.some(task => task)) {
          alert("âš ï¸ En az bir gÃ¶rev seÃ§melisiniz.");
          return;
        }

        // Tarihi Unix timestamp'e Ã§evir
        const deadline = Math.floor(new Date(deadlineInput).getTime() / 1000);
        const now = Math.floor(Date.now() / 1000);
        
        if (deadline <= now) {
          alert("âš ï¸ BitiÅŸ tarihi gelecekte olmalÄ±dÄ±r.");
          return;
        }

        // Transaction gÃ¶nder
        const fee = ethers.utils.parseEther("0.001");
        const tx = await contract.createDraw(title, deadline, tasks, { value: fee });
        
        alert("â³ Ä°ÅŸlem gÃ¶nderildi. OnaylanmasÄ± bekleniyor...");
        await tx.wait();
        
        alert("âœ… Ã‡ekiliÅŸ baÅŸarÄ±yla baÅŸlatÄ±ldÄ±!");
        hideCreateForm();
        await listDraws();

        // Form temizleme
        document.getElementById("newTitle").value = "";
        document.getElementById("newEnd").value = "";
        document.querySelectorAll("#createSection input[type='checkbox']").forEach(cb => cb.checked = false);

      } catch (err) {
        console.error("Ã‡ekiliÅŸ oluÅŸturma hatasÄ±:", err);
        if (err.code === 4001) {
          alert("âŒ Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan reddedildi.");
        } else if (err.message.includes("insufficient funds")) {
          alert("âŒ Yetersiz bakiye. 0.001 ETH + gas Ã¼creti gereklidir.");
        } else {
          alert("âŒ Ã‡ekiliÅŸ oluÅŸturulurken bir hata oluÅŸtu: " + (err.reason || err.message));
        }
      }
    }

    async function listDraws() {
      try {
        if (!contract) {
          // Contract baÄŸlÄ± deÄŸilse sadece placeholder gÃ¶ster
          const list = document.getElementById("drawList");
          list.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><h3>Ã‡ekiliÅŸleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n</h3></div>';
          return;
        }

        const drawCount = await contract.getDrawCount();
        const list = document.getElementById("drawList");
        list.innerHTML = "";
        draws = [];

        if (drawCount.toNumber() === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><h3>HenÃ¼z Ã§ekiliÅŸ bulunmuyor</h3><p>Ä°lk Ã§ekiliÅŸi siz baÅŸlatÄ±n!</p></div>';
          return;
        }

        for (let i = 0; i < drawCount.toNumber(); i++) {
          try {
            const drawData = await contract.getDraw(i);
            const draw = {
              id: i,
              title: drawData[0],
              deadline: drawData[1].toNumber(),
              tasks: drawData[2],
              creator: drawData[3],
              winner: drawData[4],
              participants: drawData[5],
              isActive: drawData[6],
              winnerSelected: drawData[7]
            };
            
            draws.push(draw);

            const isActive = draw.isActive && (draw.deadline * 1000) > Date.now();
            const deadlineDate = new Date(draw.deadline * 1000);
            
            const div = document.createElement("div");
            div.className = "draw-card";
            div.onclick = () => showDrawDetails(i);
            
            div.innerHTML = `
              <h3>${draw.title}</h3>
              <p>ğŸ“… BitiÅŸ: ${deadlineDate.toLocaleDateString('tr-TR')}</p>
              <p>ğŸ‘¤ OluÅŸturan: ${draw.creator.slice(0, 6)}...${draw.creator.slice(-4)}</p>
              <div class="participant-count">ğŸ‘¥ ${draw.participants.length} katÄ±lÄ±mcÄ±</div>
              <span class="status-badge ${isActive ? 'status-active' : 'status-ended'}">
                ${isActive ? 'ğŸŸ¢ Aktif' : 'ğŸ”´ Sona Erdi'}
              </span>
              ${draw.winner !== ethers.constants.AddressZero ? 
                `<div style="margin-top: 10px; color: #ffd700;">ğŸ† Kazanan: ${draw.winner.slice(0, 6)}...${draw.winner.slice(-4)}</div>` : 
                ''}
            `;
            list.appendChild(div);
          } catch (err) {
            console.error(`Draw ${i} yÃ¼klenirken hata:`, err);
          }
        }

      } catch (err) {
        console.error("Ã‡ekiliÅŸler yÃ¼klenirken hata:", err);
        const list = document.getElementById("drawList");
        list.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;"><h3>Ã‡ekiliÅŸler yÃ¼klenirken hata oluÅŸtu</h3><p>LÃ¼tfen sayfayÄ± yenileyin.</p></div>';
      }
    }

    async function showDrawDetails(index) {
      try {
        currentDrawIndex = index;
        const draw = draws[index];
        
        document.getElementById("drawTitle").textContent = draw.title;
        document.getElementById("drawDeadline").textContent = new Date(draw.deadline * 1000).toLocaleDateString('tr-TR');
        document.getElementById("drawParticipants").textContent = draw.participants.length;
        document.getElementById("winnerAddress").textContent = 
          (draw.winner && draw.winner !== ethers.constants.AddressZero) ? 
          `${draw.winner.slice(0, 10)}...${draw.winner.slice(-4)}` : 
          "HenÃ¼z belirlenmedi";

        // GÃ¶revleri listele
        const tasksList = document.getElementById("tasksList");
        const taskNames = ["ğŸ‘¥ Twitter hesabÄ±nÄ± takip et", "â¤ï¸ Tweet'i beÄŸen", "ğŸ”„ Tweet'i retweetle", "ğŸ’¬ Tweet'e yorum yap"];
        tasksList.innerHTML = "";

        draw.tasks.forEach((required, i) => {
          if (required) {
            const li = document.createElement("li");
            li.innerHTML = `<input type="checkbox" id="task${i}" disabled> ${taskNames[i]}`;
            tasksList.appendChild(li);
          }
        });

        // KatÄ±lÄ±m durumunu kontrol et
        let isParticipant = false;
        if (userAccount && contract) {
          try {
            isParticipant = await contract.isParticipant(draw.id, userAccount);
          } catch (err) {
            console.error("KatÄ±lÄ±m durumu kontrol edilemedi:", err);
          }
        }

        const isActive = draw.isActive && (draw.deadline * 1000) > Date.now();
        const isCreator = userAccount && draw.creator.toLowerCase() === userAccount.toLowerCase();

        document.getElementById("joinBtn").disabled = !userAccount || isParticipant || !isActive;
        document.getElementById("joinBtn").textContent = isParticipant ? "âœ… Zaten KatÄ±ldÄ±nÄ±z" : "âœ¨ Ã‡ekiliÅŸe KatÄ±l";

        // Kazanan seÃ§me butonu (sadece yaratÄ±cÄ± iÃ§in ve Ã§ekiliÅŸ bittiÄŸinde)
        const selectWinnerBtn = document.getElementById("selectWinnerBtn");
        if (isCreator && !isActive && draw.participants.length > 0 && !draw.winnerSelected) {
          selectWinnerBtn.style.display = "inline-block";
        } else {
          selectWinnerBtn.style.display = "none";
        }

        document.getElementById("drawDetails").style.display = "block";
        document.getElementById("createSection").style.display = "none";
      } catch (err) {
        console.error("Ã‡ekiliÅŸ detaylarÄ± yÃ¼klenirken hata:", err);
        alert("âŒ Ã‡ekiliÅŸ detaylarÄ± yÃ¼klenemedi.");
      }
    }

    function simulateTasks() {
      // GÃ¶revleri simÃ¼le et (gerÃ§ek uygulamada API Ã§aÄŸrÄ±larÄ± yapÄ±lacak)
      const draw = draws[currentDrawIndex];
      const taskCheckboxes = document.querySelectorAll("#tasksList input[type='checkbox']");
      
      let completedTasks = 0;
      taskCheckboxes.forEach((checkbox, index) => {
        // %80 ihtimalle gÃ¶revi tamamlamÄ±ÅŸ gibi gÃ¶ster
        const completed = Math.random() > 0.2;
        checkbox.checked = completed;
        if (completed) completedTasks++;
      });

      const totalTasks = taskCheckboxes.length;
      if (completedTasks === totalTasks) {
        alert(`âœ… TÃ¼m gÃ¶revler tamamlandÄ±! (${completedTasks}/${totalTasks})`);
        document.getElementById("joinBtn").disabled = false;
      } else {
        alert(`âš ï¸ ${totalTasks - completedTasks} gÃ¶rev daha tamamlanmasÄ± gerekiyor.`);
      }
    }

    async function joinDraw() {
      try {
        if (!userAccount || !contract) {
          alert("âš ï¸ Ã–nce cÃ¼zdanÄ±nÄ±zÄ± baÄŸlayÄ±n.");
          return;
        }

        const draw = draws[currentDrawIndex];
        
        // GÃ¶revlerin tamamlanÄ±p tamamlanmadÄ±ÄŸÄ±nÄ± kontrol et
        const taskCheckboxes = document.querySelectorAll("#tasksList input[type='checkbox']");
        const allCompleted = Array.from(taskCheckboxes).every(cb => cb.checked);

        if (!allCompleted) {
          alert("âŒ Ã–nce tÃ¼m gÃ¶revleri tamamlamalÄ±sÄ±nÄ±z.");
          return;
        }

        // Blockchain'e katÄ±lÄ±m isteÄŸi gÃ¶nder
        const tx = await contract.joinDraw(draw.id);
        alert("â³ Ä°ÅŸlem gÃ¶nderildi. OnaylanmasÄ± bekleniyor...");
        await tx.wait();

        alert("ğŸ‰ Ã‡ekiliÅŸe baÅŸarÄ±yla katÄ±ldÄ±nÄ±z!");
        
        // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
        await listDraws();
        await showDrawDetails(currentDrawIndex);

      } catch (err) {
        console.error("KatÄ±lÄ±m hatasÄ±:", err);
        if (err.code === 4001) {
          alert("âŒ Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan reddedildi.");
        } else if (err.message.includes("Already joined")) {
          alert("â„¹ï¸ Zaten bu Ã§ekiliÅŸe katÄ±ldÄ±nÄ±z.");
        } else if (err.message.includes("Draw has ended")) {
          alert("âŒ Ã‡ekiliÅŸ sÃ¼resi dolmuÅŸ.");
        } else {
          alert("âŒ KatÄ±lÄ±m sÄ±rasÄ±nda hata oluÅŸtu: " + (err.reason || err.message));
        }
      }
    }

    async function selectWinner() {
      try {
        const draw = draws[currentDrawIndex];
        
        if (draw.participants.length === 0) {
          alert("âŒ HenÃ¼z katÄ±lÄ±mcÄ± yok.");
          return;
        }

        // Ã‡arkÄ± gÃ¶ster ve kazananÄ± seÃ§
        participants = draw.participants;
        document.getElementById("wheelCanvas").style.display = "block";
        document.getElementById("spinButton").style.display = "inline-block";
        drawWheel();
      } catch (err) {
        console.error("Kazanan seÃ§im hatasÄ±:", err);
        alert("âŒ Kazanan seÃ§ilirken hata oluÅŸtu.");
      }
    }

    function drawWheel() {
      const canvas = document.getElementById("wheelCanvas");
      const ctx = canvas.getContext("2d");
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 180;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (participants.length === 0) return;

      const anglePerSlice = (2 * Math.PI) / participants.length;
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];

      participants.forEach((participant, index) => {
        const startAngle = index * anglePerSlice;
        const endAngle = startAngle + anglePerSlice;
        const color = colors[index % colors.length];

        // Dilimi Ã§iz
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Metin ekle
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + anglePerSlice / 2);
        ctx.textAlign = 'center';
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px Arial';
        const text = participant.slice(0, 6) + '...';
        ctx.fillText(text, radius / 2, 5);
        ctx.restore();
      });

      // Merkez daire
      ctx.beginPath();
      ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
      ctx.fillStyle = '#333';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 3;
      ctx.stroke();

      // Ok Ã§iz
      ctx.beginPath();
      ctx.moveTo(centerX + radius + 10, centerY);
      ctx.lineTo(centerX + radius - 10, centerY - 15);
      ctx.lineTo(centerX + radius - 10, centerY + 15);
      ctx.closePath();
      ctx.fillStyle = '#FF6B6B';
      ctx.fill();
    }

    let spinning = false;
    async function spinWheel() {
      if (spinning) return;
      spinning = true;

      const canvas = document.getElementById("wheelCanvas");
      let rotation = 0;
      const spinDuration = 3000;
      const spinSpeed = Math.random() * 360 + 1440; // 4-8 tam tur

      const startTime = Date.now();
      
      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / spinDuration, 1);
        
        // Easing function (yavaÅŸlayarak dur)
        const easeOut = 1 - Math.pow(1 - progress, 3);
        rotation = spinSpeed * easeOut;

        canvas.style.transform = `rotate(${rotation}deg)`;

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // KazananÄ± belirle
          const normalizedRotation = (360 - (rotation % 360)) % 360;
          const anglePerSlice = 360 / participants.length;
          const winnerIndex = Math.floor(normalizedRotation / anglePerSlice);
          const winner = participants[winnerIndex];
          
          setTimeout(async () => {
            try {
              // Blockchain'e kazananÄ± kaydet
              if (contract) {
                const tx = await contract.setWinner(draws[currentDrawIndex].id, winner);
                alert("â³ Kazanan kaydediliyor...");
                await tx.wait();
              }
              
              alert(`ğŸ‰ Tebrikler! Kazanan: ${winner.slice(0, 10)}...${winner.slice(-4)}`);
              
              // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
              await listDraws();
              await showDrawDetails(currentDrawIndex);
              
              spinning = false;
              document.getElementById("wheelCanvas").style.display = "none";
              document.getElementById("spinButton").style.display = "none";
            } catch (err) {
              console.error("Kazanan kaydetme hatasÄ±:", err);
              alert("âŒ Kazanan kaydedilirken hata oluÅŸtu: " + (err.reason || err.message));
              spinning = false;
            }
          }, 500);
        }
      }
      
      animate();
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('tr-TR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Sayfa yÃ¼klendiÄŸinde Ã§ekiliÅŸleri listele
    window.addEventListener('load', () => {
      listDraws();
    });
  </script>
</body>
</html>
